<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Write and Download G-code</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      margin: 20px;
    }
    canvas {
      border: 1px solid black;
      cursor: crosshair;
      background: #fff;
    }
    button {
      margin: 10px;
      padding: 10px 20px;
      font-size: 16px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <h1>Write on the Canvas</h1>
  <p>Draw below and download the G-code file.</p>
  <!-- A5 size in pixels: 210mm x 297mm at 96 DPI -->
  <canvas id="drawingCanvas" width="794" height="1123"></canvas>
  <div>
    <button id="clearButton">Clear</button>
    <button id="downloadButton">Download G-code</button>
  </div>

  <script>
    const canvas = document.getElementById('drawingCanvas');
    const ctx = canvas.getContext('2d');

    let isDrawing = false;
    let paths = []; // Stores all strokes
    let currentPath = []; // Stores the current stroke

    // Set up canvas context styles
    ctx.lineWidth = 2; // Line thickness
    ctx.lineCap = 'round'; // Round edges for smoother lines
    ctx.strokeStyle = 'black'; // Line color

    // Start drawing
    canvas.addEventListener('mousedown', (event) => {
      isDrawing = true;
      currentPath = [];
      const rect = canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      currentPath.push({ x, y });
      ctx.beginPath();
      ctx.moveTo(x, y);
    });

    // Draw while the mouse is moving
    canvas.addEventListener('mousemove', (event) => {
      if (!isDrawing) return;
      const rect = canvas.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;
      currentPath.push({ x, y });
      ctx.lineTo(x, y);
      ctx.stroke();
    });

    // End drawing
    canvas.addEventListener('mouseup', () => {
      if (isDrawing) {
        paths.push(currentPath);
        isDrawing = false;
      }
    });

    // Clear the canvas and reset paths
    document.getElementById('clearButton').addEventListener('click', () => {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      paths = [];
    });

    // Convert strokes to G-code
    function strokesToGCode(strokes, feedrate = 1200, liftHeight = 5) {
      let gcode = [
        "G21 ; Set units to mm",
        "G90 ; Absolute positioning",
      ];

      const scale = 0.264583; // Convert pixels to mm (96 DPI)

      for (const stroke of strokes) {
        if (stroke.length === 0) continue;

        // Lift the tool
        gcode.push(`G0 Z${liftHeight}`);

        // Move to the starting point of the stroke
        const start = stroke[0];
        gcode.push(`G0 X${(start.x * scale).toFixed(2)} Y${(start.y * scale).toFixed(2)}`);

        // Lower the tool
        gcode.push("G0 Z0");

        // Draw the stroke
        for (const point of stroke) {
          gcode.push(`G1 X${(point.x * scale).toFixed(2)} Y${(point.y * scale).toFixed(2)} F${feedrate}`);
        }
      }

      // Final lift
      gcode.push(`G0 Z${liftHeight}`);

      return gcode.join("\n");
    }

    // Download G-code
    document.getElementById('downloadButton').addEventListener('click', () => {
      if (paths.length === 0) {
        alert('Please draw something before downloading.');
        return;
      }

      const gcode = strokesToGCode(paths);

      // Create a downloadable blob
      const blob = new Blob([gcode], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);

      // Trigger file download
      const a = document.createElement('a');
      a.href = url;
      a.download = 'drawing.gcode';
      a.click();

      URL.revokeObjectURL(url); // Clean up
    });
  </script>
</body>
</html>
